name: Release & Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  build-native:
    name: Build ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 glibc
          - platform: linux-x64-glibc
            os: ubuntu-latest
            node: '22.x'
            use-docker: true

          # Linux x64 musl
          - platform: linux-x64-musl
            os: ubuntu-latest
            node: '22.x'
            use-docker: true

          # macOS 15 Intel
          - platform: darwin-x64
            os: macos-15-intel
            node: '22.x'

          # macOS 15 ARM64
          - platform: darwin-arm64
            os: macos-15
            node: '22.x'

          # Windows x64
          - platform: win32-x64
            os: windows-latest
            node: '22.x'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        if: ${{ !matrix.use-docker }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup MSVC
        if: matrix.platform == 'win32-x64'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # Standard build for non-Docker platforms
      - name: Install pnpm
        if: ${{ !matrix.use-docker }}
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        if: ${{ !matrix.use-docker }}
        run: pnpm install --frozen-lockfile

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Export GHA cache variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Build LIEF
        if: ${{ !matrix.use-docker }}
        env:
          SCCACHE_GHA_ENABLED: "true"
          CMAKE_C_COMPILER_LAUNCHER: sccache
          CMAKE_CXX_COMPILER_LAUNCHER: sccache
        run: pnpm build:lief

      - name: Prebuildify
        if: ${{ !matrix.use-docker }}
        run: pnpm prebuildify

      # Manylinux build via Docker
      - name: Build for Linux (glibc)
        if: matrix.use-docker && matrix.platform == 'linux-x64-glibc'
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace \
            -e SCCACHE_GHA_ENABLED="true" \
            -e ACTIONS_CACHE_URL="${ACTIONS_CACHE_URL}" \
            -e ACTIONS_RESULTS_URL="${ACTIONS_RESULTS_URL}" \
            -e ACTIONS_RUNTIME_TOKEN="${ACTIONS_RUNTIME_TOKEN}" \
            quay.io/pypa/manylinux_2_28_x86_64 \
            bash -c '
              # Install Node.js
              curl -fsSL https://rpm.nodesource.com/setup_22.x | bash -
              dnf install -y nodejs

              # Install build dependencies
              dnf install -y python3.12 ninja-build

              # Install sccache
              curl -L https://github.com/mozilla/sccache/releases/download/v0.12.0/sccache-v0.12.0-x86_64-unknown-linux-musl.tar.gz | tar xz
              mv sccache-*/sccache /usr/local/bin/
              chmod +x /usr/local/bin/sccache

              # Configure git for submodules
              git config --global --add safe.directory /workspace
              git config --global --add safe.directory /workspace/LIEF
              git submodule update --init --recursive

              # Install pnpm
              npm install -g pnpm@10.20.0

              # Install dependencies and build (specify Python 3.12 for node-gyp)
              export npm_config_python=/usr/bin/python3.12
              pnpm install --frozen-lockfile
              pnpm build:lief
              pnpm prebuildify
            '

      # Alpine Linux build via Docker
      - name: Build for Alpine Linux (musl)
        if: matrix.use-docker && matrix.platform == 'linux-x64-musl'
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace \
            -e SCCACHE_GHA_ENABLED="true" \
            -e ACTIONS_CACHE_URL="${ACTIONS_CACHE_URL}" \
            -e ACTIONS_RESULTS_URL="${ACTIONS_RESULTS_URL}" \
            -e ACTIONS_RUNTIME_TOKEN="${ACTIONS_RUNTIME_TOKEN}" \
            alpine:latest \
            sh -c '
              apk add --no-cache \
                nodejs npm python3 make g++ git cmake bash curl \
                samurai linux-headers sccache

              # Configure git for submodules
              git config --global --add safe.directory /workspace
              git config --global --add safe.directory /workspace/LIEF
              git submodule update --init --recursive

              # Install pnpm
              npm install -g pnpm@10.20.0

              # Install dependencies and build
              pnpm install --frozen-lockfile
              pnpm build:lief
              pnpm prebuildify --tag-libc
            '

      - name: Fix permissions
        if: matrix.use-docker
        run: sudo chown -R $(id -u):$(id -g) prebuilds

      - name: Upload prebuilds
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{ matrix.platform }}
          path: prebuilds/
          retention-days: 1

  publish:
    needs: build-native
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Download all platform prebuilds and merge them
      - name: Download Linux x64 glibc prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-linux-x64-glibc
          path: prebuilds

      - name: Download Linux x64 musl prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-linux-x64-musl
          path: prebuilds

      - name: Download macOS x64 prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-darwin-x64
          path: prebuilds

      - name: Download macOS ARM64 prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-darwin-arm64
          path: prebuilds

      - name: Download Windows x64 prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-win32-x64
          path: prebuilds

      - name: List prebuilds
        run: ls -lah prebuilds/

      - name: Publish to npm
        run: pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
