name: Release & Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  build-native:
    name: Build ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64 glibc (Ubuntu 24.04)
          - platform: linux-x64-glibc
            os: ubuntu-24.04
            node: '22.x'

          # Linux x64 musl (Alpine)
          - platform: linux-x64-musl
            os: ubuntu-latest
            node: '22.x'
            use-docker: true

          # macOS 15 Intel
          - platform: darwin-x64
            os: macos-15-intel
            node: '22.x'

          # macOS 15 ARM64
          - platform: darwin-arm64
            os: macos-15
            node: '22.x'

          # Windows x64
          - platform: win32-x64
            os: windows-latest
            node: '22.x'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        if: ${{ !matrix.use-docker }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup MSVC
        if: matrix.platform == 'win32-x64'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # Standard build for non-Docker platforms
      - name: Install pnpm
        if: ${{ !matrix.use-docker }}
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        if: ${{ !matrix.use-docker }}
        run: pnpm install --frozen-lockfile

      - name: Cache LIEF build
        if: ${{ !matrix.use-docker }}
        uses: actions/cache@v4
        with:
          path: lief-build
          key: lief-v1-${{ matrix.platform }}-${{ hashFiles('.gitmodules', 'scripts/build-lief.sh') }}
          restore-keys: |
            lief-v1-${{ matrix.platform }}-

      - name: Build LIEF
        if: ${{ !matrix.use-docker }}
        run: pnpm build:lief

      - name: Prebuildify
        if: ${{ !matrix.use-docker }}
        run: pnpm prebuildify

      # Alpine Linux build via Docker
      - name: Cache LIEF build (Alpine)
        if: matrix.use-docker && matrix.platform == 'linux-x64-musl'
        uses: actions/cache@v4
        with:
          path: lief-build
          key: lief-v1-${{ matrix.platform }}-${{ hashFiles('.gitmodules', 'scripts/build-lief.sh') }}
          restore-keys: |
            lief-v1-${{ matrix.platform }}-

      - name: Build for Alpine Linux (musl)
        if: matrix.use-docker && matrix.platform == 'linux-x64-musl'
        run: |
          docker run --rm -v "$PWD":/workspace -w /workspace \
            alpine:latest \
            sh -c '
              apk add --no-cache \
                nodejs npm python3 make g++ git cmake bash curl \
                samurai linux-headers

              # Configure git for submodules
              git config --global --add safe.directory /workspace
              git config --global --add safe.directory /workspace/LIEF
              git submodule update --init --recursive

              # Install pnpm
              npm install -g pnpm@10.20.0

              # Install dependencies and build
              pnpm install --frozen-lockfile
              pnpm build:lief
              pnpm prebuildify
            '

      - name: Upload prebuilds
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{ matrix.platform }}
          path: prebuilds/
          retention-days: 1

  publish:
    needs: build-native
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Download all platform prebuilds and merge them
      - name: Download Linux x64 glibc prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-linux-x64-glibc
          path: prebuilds

      - name: Download Linux x64 musl prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-linux-x64-musl
          path: prebuilds

      - name: Download macOS x64 prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-darwin-x64
          path: prebuilds

      - name: Download macOS ARM64 prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-darwin-arm64
          path: prebuilds

      - name: Download Windows x64 prebuilds
        uses: actions/download-artifact@v4
        with:
          name: prebuilds-win32-x64
          path: prebuilds

      - name: List prebuilds
        run: ls -lah prebuilds/

      - name: Publish to npm
        run: pnpm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: prebuilds/**/*
